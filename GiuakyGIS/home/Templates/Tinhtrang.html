<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tình Trạng Giao Hàng - FastFood Universe</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .status-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; }
        
        /* Progress Stepper */
        .stepper { display: flex; justify-content: space-between; margin-top: 30px; position: relative; }
        .stepper::before { content: ''; position: absolute; top: 20px; left: 10%; right: 10%; height: 2px; background: #ddd; z-index: 1; }
        .step { position: relative; z-index: 2; width: 25%; }
        .circle { width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; color: white; transition: 0.5s; }
        .step.active .circle { background: #d62828; box-shadow: 0 0 15px rgba(214, 40, 40, 0.3); }
        .step.active p { color: #d62828; font-weight: 600; }
        .step p { font-size: 0.8rem; margin: 0; color: #888; }

        #map { height: 400px; border-radius: 15px; margin-top: 20px; border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .info-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .info-item { background: white; padding: 15px; border-radius: 12px; border-left: 5px solid #d62828; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .info-item small { color: #888; display: block; font-size: 0.8rem; }
        .info-item strong { color: #333; font-size: 1.1rem; }

        .back-home { display: inline-block; margin-top: 20px; text-decoration: none; color: #666; font-size: 0.9rem; transition: 0.3s; }
        .back-home:hover { color: #d62828; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-card">
        <h2 id="order-user">Đang tải đơn hàng...</h2>
        <p id="order-address" style="color: #666; font-size: 0.9rem; margin-top: 5px;"></p>
        
        <div class="stepper">
            <div class="step active" id="s1"><div class="circle"><i class="fa-solid fa-check"></i></div><p>Đã nhận</p></div>
            <div class="step" id="s2"><div class="circle"><i class="fa-solid fa-fire"></i></div><p>Đang làm</p></div>
            <div class="step" id="s3"><div class="circle"><i class="fa-solid fa-truck"></i></div><p>Đang giao</p></div>
            <div class="step" id="s4"><div class="circle"><i class="fa-solid fa-house-chimney"></i></div><p>Đã giao</p></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="info-panel">
        <div class="info-item">
            <small><i class="fa-solid fa-route"></i> Khoảng cách:</small>
            <strong id="distance-text">Đang tính...</strong>
        </div>
        <div class="info-item">
            <small><i class="fa-solid fa-clock"></i> Thời gian còn lại:</small>
            <strong id="time-text">Đang tính...</strong>
        </div>
    </div>
    
    <div style="text-align: center;">
        <a href="{% url 'home' %}" class="back-home">← Quay về trang chủ</a>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Cấu hình
    const shopLoc = [10.8122, 106.6346];
    const customerLoc = [10.8000, 106.6180]; 
    const avgSpeedKmMin = 30 / 60; // 30km/h đổi ra km/phút
    const preparationTime = 5; // 5 phút làm món

    const order = JSON.parse(localStorage.getItem('current_order'));
    if (order) {
        document.getElementById('order-user').innerText = "Đơn hàng của " + order.customerName;
        document.getElementById('order-address').innerText = "Giao đến: " + order.customerAddress;
    }

    // 2. Tính toán ban đầu
    function calculateDistance(lat1, lon1, lat2, lon2) {
        var R = 6371;
        var dLat = (lat2 - lat1) * Math.PI / 180;
        var dLon = (lon2 - lon1) * Math.PI / 180;
        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    const distance = calculateDistance(shopLoc[0], shopLoc[1], customerLoc[0], customerLoc[1]);
    const deliveryTime = Math.ceil(distance / avgSpeedKmMin); // Thời gian di chuyển thực tế
    let totalSecondsRemaining = (preparationTime + deliveryTime) * 60;

    document.getElementById('distance-text').innerText = distance.toFixed(2) + " km";

    // 3. Khởi tạo Bản đồ
    var map = L.map('map').setView(shopLoc, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    L.circleMarker(shopLoc, {radius: 8, color: 'red', fillColor: '#f03', fillOpacity: 0.8}).addTo(map).bindPopup("Quán");
    L.circleMarker(customerLoc, {radius: 8, color: 'blue', fillColor: '#30f', fillOpacity: 0.8}).addTo(map).bindPopup("Khách");
    L.polyline([shopLoc, customerLoc], {color: 'gray', dashArray: '5, 10', weight: 2}).addTo(map);

    // 4. Logic đếm ngược và chuyển trạng thái thực
    const countdown = setInterval(() => {
        totalSecondsRemaining--;

        if (totalSecondsRemaining <= 0) {
            clearInterval(countdown);
            updateStepper(4);
            document.getElementById('time-text').innerText = "Đã hoàn thành!";
            alert("Đơn hàng đã được giao thành công!");
            return;
        }

        const mins = Math.floor(totalSecondsRemaining / 60);
        const secs = totalSecondsRemaining % 60;
        document.getElementById('time-text').innerText = `${mins}p ${secs}s`;

        // Chuyển trạng thái dựa trên thời gian
        // Nếu thời gian còn lại > thời gian giao hàng -> Đang chuẩn bị (Bước 2)
        if (totalSecondsRemaining > deliveryTime * 60) {
            updateStepper(2);
        } 
        // Nếu thời gian còn lại <= thời gian giao hàng -> Đang giao (Bước 3)
        else {
            updateStepper(3);
        }

    }, 1000); // Cập nhật mỗi giây

    function updateStepper(step) {
        for (let i = 1; i <= 4; i++) {
            const el = document.getElementById('s' + i);
            if (i <= step) el.classList.add('active');
            else el.classList.remove('active');
        }
    }
</script>
</body>
</html>